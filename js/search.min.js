(function(){function loadData(success){if(searchData)success(searchData);else{var xhr=new XMLHttpRequest;xhr.open("GET",JSON_DATA,!0),xhr.onload=function(){if(this.status>=200&&this.status<300){var res=JSON.parse(this.response);searchData=res instanceof Array?res:res.posts,success(searchData)}else console.error(this.statusText)},xhr.onerror=function(){console.error(this.statusText)},xhr.send()}}function tpl(html,data){return html.replace(/\{\w+\}/g,function(str){var prop=str.replace(/\{|\}/g,"");return data[prop]||""})}function getMatch(text,regExp){index_content=text.indexOf(regExp),index_content<0&&(index_content=0),first_occur=index_content;var content=text.trim().replace(/<[^>]+>/g,"");if(first_occur>=0){var start=first_occur-20,end=first_occur+80;start<0&&(start=0),0==start&&(end=100),end>content.length&&(end=content.length);var match_content=content.slice(start,end),regS=new RegExp(regExp,"gi");match_content=match_content.replace(regS,'<em class="search-keyword">'+regExp+"</em>")}else match_content="";return match_content}function render(data,regExp){var html="";html=data.length?data.map(function(post){var text=getMatch(post.text,regExp);return tpl(searchTpl,{title:post.title,path:(G.BLOG.ROOT+"/"+post.path).replace(/\/{2,}/g,"/"),date:new Date(post.date).toLocaleDateString(),tags:post.tags.map(function(tag){return"<span>#"+tag.name+"</span>"}).join(""),content:text+"..."})}).join(""):'<li class="tips"><i class="icon icon-coffee icon-3x"></i><p>Results not found!</p></li>',searchResult.innerHTML=html}function regtest(raw,regExp){return regExp.lastIndex=0,regExp.test(raw)}function matcher(post,regExp){return regtest(post.title,regExp)||post.tags.some(function(tag){return regtest(tag.name,regExp)})||regtest(post.text,regExp)}function search(e){var key=this.value.trim();if(key){var regExp=new RegExp(key.replace(/[ ]/g,"|"),"gmi");loadData(function(data){render(data.filter(function(post){return matcher(post,regExp)}),key.replace(/[ ]/g,"|")),Control.show()}),e.preventDefault()}}var searchData,G=window||this,even=G.BLOG.even,$=G.BLOG.$,searchIco=$("#search"),searchWrap=$("#search-wrap"),keyInput=$("#key"),back=$("#back"),searchPanel=$("#search-panel"),searchResult=$("#search-result"),searchTpl=$("#search-tpl").innerHTML,JSON_DATA=(G.BLOG.ROOT+"/content.json").replace(/\/{2}/g,"/"),root=(G.BLOG.noop,$("html")),Control={show:function(){G.innerWidth<760&&root.classList.add("lock-size"),searchPanel.classList.add("in")},hide:function(){G.innerWidth<760&&root.classList.remove("lock-size"),searchPanel.classList.remove("in")}};searchIco.addEventListener(even,function(){searchWrap.classList.toggle("in"),keyInput.value="",searchWrap.classList.contains("in")?keyInput.focus():keyInput.blur()}),back.addEventListener(even,function(){searchWrap.classList.remove("in"),Control.hide()}),document.addEventListener(even,function(e){"key"!==e.target.id&&"click"===even&&Control.hide()}),keyInput.addEventListener("input",search),keyInput.addEventListener(even,search)}).call(this);